<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI Public Health Chatbot ‚Äî Skin Condition Detector</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
  <div class="bg-white shadow-xl rounded-2xl p-6 w-full max-w-lg text-center">
    <h1 class="text-2xl font-bold text-blue-600 mb-3">ü©∫ AI Health Detector</h1>
    <p class="text-gray-600 mb-5">Upload an image and get instant medical guidance (I'm a prototype, not medical advice ‚Äî consult a doctor).</p>

    <input type="file" id="imageUpload" accept="image/*" class="mb-4 block w-full border border-gray-300 rounded-lg p-2" />
    <img id="preview" class="mx-auto mb-4 hidden rounded-lg shadow-md" width="280" />

    <!-- Alert Banner -->
    <div id="alertBanner" class="hidden mb-4 p-3 rounded-lg font-semibold"></div>

    <!-- Structured output -->
    <div id="output" class="text-left space-y-3 hidden">
      <p><strong class="text-blue-600">Medical issue detected:</strong> <span id="detected">‚Äî</span></p>

      <div>
        <strong class="text-blue-600">Possible conditions:</strong>
        <ul id="possibilities" class="list-disc list-inside text-sm text-gray-700 mt-1"></ul>
      </div>

      <p><strong class="text-blue-600">Steps to be taken:</strong> <span id="steps">‚Äî</span></p>
      <p><strong class="text-blue-600">Danger level:</strong> <span id="dangerBadge" class="inline-block px-3 py-1 rounded text-white">‚Äî</span></p>

      <div>
        <strong class="text-blue-600">Medical summary:</strong>
        <p id="summary" class="text-sm text-gray-700 mt-1">‚Äî</p>
      </div>
    </div>

    <div id="result" class="text-lg font-semibold text-gray-700 mt-4"></div>
  </div>

  <script>
    // Elements
    const imageUpload = document.getElementById("imageUpload");
    const preview = document.getElementById("preview");
    const result = document.getElementById("result");
    const output = document.getElementById("output");
    const alertBanner = document.getElementById("alertBanner");

    const detectedEl = document.getElementById("detected");
    const possibilitiesEl = document.getElementById("possibilities");
    const stepsEl = document.getElementById("steps");
    const dangerBadge = document.getElementById("dangerBadge");
    const summaryEl = document.getElementById("summary");

    // ====== CONFIG ======
    const HF_API_TOKEN = "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"; // your token
    const MODEL_URL = "https://api-inference.huggingface.co/models/Anwarkh1/Skin_Cancer-Image_Classification";
    // ====================

    function dangerBadgeClass(level) {
      switch (level) {
        case "High": return "bg-red-600";
        case "Medium": return "bg-yellow-400 text-black";
        case "Low": return "bg-green-600";
        default: return "bg-gray-500";
      }
    }

    // ====== Mapping function ======
    function mapConditionToGuidance(label, confidence) {
      const L = label.toLowerCase();

      if (confidence < 70 || L.includes("normal") || L.includes("benign") || L.includes("nevus")) {
        return {
          steps: "No immediate concern detected. Maintain normal skin care and routine check-ups.",
          danger: "Low",
          summary: "‚úÖ No significant medical issue detected. Safe condition."
        };
      }

      if (L.includes("melanoma")) {
        return {
          steps: "Seek urgent medical evaluation, melanoma can spread quickly.",
          danger: "High",
          summary: "‚ö†Ô∏è Melanoma detected. Immediate consultation with a dermatologist is advised."
        };
      }
      if (L.includes("carcinoma")) {
        return {
          steps: "Apply bandage from first aid kit then consult a doctor.",
          danger: "Medium",
          summary: "‚ö†Ô∏è Carcinoma indication. Professional medical evaluation recommended."
        };
      }
      if (L.includes("keratosis")) {
        return {
          steps: "Monitor lesion, avoid sun exposure, consult doctor if worsening.",
          danger: "Medium",
          summary: "‚òÄÔ∏è Actinic keratosis may progress further. Medical check-up recommended."
        };
      }

      return {
        steps: "No critical issue found. Stay observant and consult a doctor if you notice changes.",
        danger: "Low",
        summary: "‚ÑπÔ∏è General safe condition detected."
      };
    }

    // ====== Blood Detection (adaptive) ======
    function detectBlood(canvas, ctx) {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
      let redPixels = 0, totalPixels = canvas.width * canvas.height;

      for (let i = 0; i < imageData.length; i += 4) {
        const r = imageData[i];
        const g = imageData[i + 1];
        const b = imageData[i + 2];

        // Brightness & saturation checks
        const brightness = (r + g + b) / 3;
        const maxVal = Math.max(r, g, b);
        const minVal = Math.min(r, g, b);
        const saturation = (maxVal - minVal) / (maxVal || 1);

        // Adaptive condition: dark/mid red, not bright red
        if (
          r > 90 &&                // enough red
          r > g * 1.4 &&           // red dominant
          r > b * 1.4 &&
          saturation > 0.3 &&      // avoid pale colors
          brightness < 180         // avoid neon/bright clothes
        ) {
          redPixels++;
        }
      }

      return (redPixels / totalPixels) * 100; // %
    }

    async function analyzeImage(file) {
      result.innerText = "üîç Analyzing image...";
      output.classList.add("hidden");
      alertBanner.classList.add("hidden");

      try {
        // Step 1: Preview & check blood
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        await img.decode();

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        const redRatio = detectBlood(canvas, ctx);

        // Step 2: Trauma override if blood is detected
        if (redRatio > 3) { // adaptive threshold
          detectedEl.innerText = "Yes (Blood/Injury detected)";
          possibilitiesEl.innerHTML = "<li>‚ö†Ô∏è Traumatic injury (not a skin condition)</li>";
          stepsEl.innerText = "Apply pressure to stop bleeding and seek immediate medical attention.";
          dangerBadge.innerText = "High";
          dangerBadge.className = "inline-block px-3 py-1 rounded text-white bg-red-600";
          summaryEl.innerText = "üö® Active bleeding detected. This is likely trauma, not a skin condition. Urgent care needed.";

          // Show banner
          alertBanner.innerText = "üö® Severe trauma detected! Immediate medical attention required.";
          alertBanner.className = "mb-4 p-3 rounded-lg font-semibold bg-red-100 text-red-700";

          output.classList.remove("hidden");
          alertBanner.classList.remove("hidden");
          result.innerText = "";
          return;
        }

        // Step 3: Run Hugging Face skin cancer model
        const bytes = await file.arrayBuffer();
        const resp = await fetch(MODEL_URL, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${HF_API_TOKEN}`,
            "Content-Type": "application/octet-stream"
          },
          body: bytes
        });

        if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);
        const predictions = await resp.json();

        if (!Array.isArray(predictions) || predictions.length === 0) {
          throw new Error("No predictions returned.");
        }

        possibilitiesEl.innerHTML = "";
        predictions.slice(0, 3).forEach(p => {
          const li = document.createElement("li");
          li.innerText = `${p.label} ‚Äî ${(p.score * 100).toFixed(1)}%`;
          possibilitiesEl.appendChild(li);
        });

        const top = predictions[0];
        const label = top.label;
        const confidence = top.score * 100;

        detectedEl.innerText = `Yes (Accuracy: ${confidence.toFixed(1)}%)`;

        const guidance = mapConditionToGuidance(label, confidence);
        stepsEl.innerText = guidance.steps;
        dangerBadge.innerText = guidance.danger;
        dangerBadge.className = `inline-block px-3 py-1 rounded text-white ${dangerBadgeClass(guidance.danger)}`;
        summaryEl.innerText = guidance.summary;

        output.classList.remove("hidden");
        result.innerText = "";
      } catch (err) {
        console.error(err);
        result.innerText = "‚ùå Error analyzing image: " + err.message;
      }
    }

    imageUpload.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      preview.src = URL.createObjectURL(file);
      preview.classList.remove("hidden");
      await analyzeImage(file);
    });
  </script>
</body>
</html>
